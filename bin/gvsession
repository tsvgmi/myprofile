#!/bin/bash
file="$@"

SHOME=$HOME/.gvsessions
[ -d $SHOME ] || mkdir -p $SHOME
cd $SHOME

PATH=$PATH:~/etfw2/bin:~/emtools/bin

ckfile=$SHOME/gvsession.dat

lname=$(head -1 "$file" | \
        sed -e 's/^h[0-9]\. *//' -e 's/[^A-Za-z0-9]/_/g' \
            -e 's/_+/_/g' | tee $ckfile)

if [ "$lname" ]; then
  lfile=$SHOME/$lname

  if [ -L "$lfile" ]; then
    if [ -r "$lfile" ]; then
      date=$(date +%y%m%d%H%M%S)
      lfile="$lfile.$date"
    fi
    rm -f "$lfile"
  fi
  ln -s "$file" "$lfile"
  echo $lfile >$ckfile
  exec ~/bin/mvim --remote "$lfile"
else
  exec ~/bin/mvim --remote "$file"
fi
