#!/bin/bash
. ${0%/*}/../etc/tool.env
#######################################################################
# File: 	admtool
# Description:  Sysadmin tools
# Created:	2002-06-23
# $Id$
#######################################################################

PATH=$PATH:/sw/sbin:/opt/local/bin

function f_movedir {
  typeset fdir=$1 tdir=$2

  F_system mv $tdir $tdir.old || return 1
  if [ -d $fdir ]; then
    F_system mv $fdir $tdir || return 1
  fi
  F_system rm -rf $tdir.old
}

#------------------------------------------------------ Begin of script ---
#------------------------------------------------------ Begin of script ---
#------------------------------------------------------ Begin of script ---

F_subCommand $*
oper=$1; shift
case $oper in
  finder-show-hidden)
    defaults write com.apple.finder AppleShowAllFiles TRUE
    killall Finder
    ;;

  finder-hide-hidden)
    defaults write com.apple.finder AppleShowAllFiles FALSE
    killall Finder
    ;;

# Convert a DMG file to ISO file mountable on the windows box or burned to CD/DVD
  dmg2iso)
    [ $# -gt 0 ] || F_usageOper $oper
    ifile=$1
    ofile=${ifile%.*}.iso
    if [ -f $ofile ]; then
      F_confirm "$ofile exist.  Overwrite" || exit 1
      rm -f $ofile || exit 1
    fi
    F_exec hdiutil makehybrid $ifile -o $ofile
    ;;

  sync-media)
    mediav="/Volumes/SANSA_E200/MUSIC:1800 /Volumes/THIENMUSIC/MUSIC:950"
    #mediav="/Users/thienvuong/tmp2:100"
    #plists=HighRate,NewMusic,Instruments,SoundTracks,Yanni
    plists=iTuneMyWalkMan

    ftypes= countatsync=yes ropt= imgonly= 
    while getopts :iIp:v i; do
      case $i in
      p) plist=$OPTARG ;;
      i) countatsync= ;;
      I) imgonly=yes ;;
      v) ropt="$ropt -$i" ;;
      *) F_usageOper $oper ;;
      esac
    done
    let j=$OPTIND-1; shift $j; OPTIND=0

    for vol in $mediav; do
      bdir=${vol%:*}
      [ -d $bdir ] || F_abort "$bdir not found.  Connect device"
    done
    tmpf=$(F_tmpf 0)
    tmpf=test.yml
    [ "$countatsync" ] && ropt="$ropt -i1"
    if [ ! "$imgonly" ]; then
      if false; then
        F_system macruby -S itunehelp.mrb $ropt sync_media -o $tmpf \
          $plists $mediav || exit 1
        F_system macruby -S itunehelp.mrb -cv copy_media $tmpf
      else
        F_rbrun itunehelp $ropt sync_media -o $tmpf \
          $plists $mediav || exit 1
        F_rbrun itunehelp -v copy_media $tmpf
      fi
    fi
    cdir=~/.tool/images
    [ -d $cdir ] || mkdir -p $cdir
    cd ~/.tool
    for vol in $mediav; do
      F_rbrun itunehelp -cvC $cdir add_img ${vol%:*}
    done
    ;;

  mk-bridgesupport)
    [ $# -gt 0 ] || F_usageOper $oper
    app=$@
    sapp=$(echo $app | sed 's/ //g')
    F_system sdef "/Applications/$app.app" \
        | F_system sdp -fh --basename $sapp
    F_exec gen_bridge_metadata -c '-I.' $sapp.h >$sapp.bridgesupport
    ;;

  *)
    F_usageOper $oper
    ;;
esac
exit 0

