#!/bin/bash

# Simulate the open in mac on WSL.  However, also direct to use
# Windows app with WSL path if applicable
#
function f_winexec {
  typeset app=$1
  shift
  prog=$(locate --basename $app.exe | egrep "/$app.exe$" | \
    grep -v 'Recycle.Bin' | head -1)
  echo "$prog $@" >>~/debug.log
  set -x
  "$prog" "$@" &
}

function winfile {
  typeset ufile=$1

  case $ufile in
    /*) ;;
    .)  ufile=$PWD ;;
    *)  ufile=$PWD/$ufile ;;
  esac
  echo $ufile | sed -e "s,^,//wsl.localhost/${WSL_DISTRO_NAME},"
}

oopt= app=
while getopts :a:g i; do
  case $i in
    a) app=$OPTARG ;;
    g) oopt="$oopt -$i" ;;
  esac
done
let i=$OPTIND-1; shift $i; OPTIND=0
file=$1
case $file in
https:*|http:*)
  url=$(echo $1 | \
    sed -e "s,^file:///,file:////wsl.localhost/$WSL_DISTRO_NAME/,")
  shift
  f_winexec msedge $url $@
  ;;

*.html|*.mp3)
  url=file://$(winfile $1)
  [ "$app" ] || app=msedge
  f_winexec $app $url
  ;;

*.md)
  [ "$app" ] || app=Typora
  f_winexec $app $@
  ;;

*.m4a-notworking)
  file=$(echo $1 | sed -e "s,/mnt/voice,//TM-AC1900-E038/Voice,")
  shift
  [ "$app" ] || app=MediaPlayer
  set -x
  f_winexec $app $file $@
  sleep 30
  ;;

*)
  if [ ! "$app" ]; then
    [ -d "$1" ] && app=explorer
    if [ ! "$app" ]; then
      echo "***** Unsupported file: $file" >&2
      exit 1
    fi
  fi
  url=file://$(winfile $1)
  f_winexec $app $url
  ;;
esac
